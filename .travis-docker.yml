sudo: required

services:
  - docker

env:
  global:
    - REGISTRY_USER=dnissimi
    -   secure: "GeffXnKaKvd4q9cMG/QRCzIa1AR9BmSymf4p/CJsTEjWo6t6Wjuj13ltMqPU9u63wqzQOFZRm+VuRDnx33v3y94owxTGcsnP+sR6drFgpqZCop3tp5rwH8PSiuFQ3IoX0k/hVFt2Fo+BIFa+HK4YAZyg+FCdFxvr9uN1/omLVT1qKHYwy0XLOg2/d/V6hfkv3CUMfZOXF0v4Y/3CC4QOgV7VpTpXR4sn1yzfM5h3n5671YTBKl+MOwTbfbxjRkXHu7AnXBApoxF0xdBnfuiCkaTAgKRPci4LXIARpEHJ9MlPPhbfj+vEsMRujYLIlM6h0qYdqsAGM3xbRCVPNdW304PPYiPowflVyHZslynUJ7gzoppiXYY5Ar+bw3u1sW/z0P0mVbU03y1jG9lWjRO3Toa67rTNX9fZRJfTa9QuK0myYiJluchzOJPFLyn7rIXGmWB6E2pzEiszAopy0qZ5cVEDZ7bNuP1dGffuM0IL2wui/v365XV2mcHZWdlbaMEdxVbfI1uUneDJ8xyLgfq6rqwhMzzqhfkbd2ULti9V6H/fPYPMcvGJiWM8Cd14PrUwBCtvwPn1xhcS3XjcPI/atOOLpXqqgW0LpiTTPysWyp3jD9XExeTXjvvnm/FUOCvVDgLbKP3f5vK194rEIzRL3zdcWzs5bPXDiBBFpKbewqE="


script:
  - docker build -t dnissimi/devops-exercise .
  - docker run -d dnissimi/devops-exercise

after_script:
  - docker images
  - coverage erase
  - coverage run test/test-http.py "http://127.0.0.1:8080/api/v1/about" && coverage html

after_success:
  - codecov

before_deploy:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

deploy:
  provider: script
  script: docker push dnissimi/devops-exercise
  on:
    branch: master
